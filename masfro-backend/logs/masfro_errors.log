2025-11-12 20:29:14 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 20:29:14 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 20:29:14 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:29:06.390386", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:29:06.390386", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:29:06.390386", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:29:06.390386", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:29:06.390386", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 4.92, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.8, "humidity_pct": 84, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T20:00:00", "rain_mm": 0.0, "temp_c": 28.8, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.48, "humidity_pct": 83, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.05, "humidity_pct": 83, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.5, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 26.9, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.16, "humidity_pct": 86, "pop": 0}], "timestamp": "2025-11-12T20:29:06.572371", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T20:29:07.721848", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T20:29:14.773941", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 20:44:39 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 20:44:39 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 20:44:39 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:44:31.545515", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:44:31.545515", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:44:31.545515", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:44:31.545515", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T20:44:31.545515", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 4.92, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.67, "humidity_pct": 84, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T20:00:00", "rain_mm": 0.0, "temp_c": 28.42, "humidity_pct": 83, "pop": 0}, {"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.67, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.32, "humidity_pct": 83, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.85, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.32, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.46, "humidity_pct": 86, "pop": 0}], "timestamp": "2025-11-12T20:44:31.719593", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T20:44:32.849566", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T20:44:39.893211", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:36:00 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:36:00 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:36:00 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:35:52.659410", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 85, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 84, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:35:52.851042", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:35:53.774683", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:36:00.364605", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:41:09 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:41:09 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:41:09 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:41:00.540603", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.66, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.37, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.66, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 28.25, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.76, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 27, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:41:00.737436", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:41:01.692191", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:41:09.598343", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:57:03 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:57:03 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:57:03 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.26, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.05, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.26, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.93, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.52, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.6, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 26.92, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:56:57.253344", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:57:03.173664", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:57:03 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:57:03 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:57:03 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.26, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.05, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.26, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.93, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.52, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.6, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 26.92, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:56:57.253344", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:57:03.173664", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:57:03 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:57:03 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:57:03 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.26, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.05, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.26, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.93, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.52, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.6, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 26.92, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:56:57.253344", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:57:03.173664", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-12 21:57:03 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-12 21:57:03 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-12 21:57:03 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-12T21:56:57.059912", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 5.08, "forecast_6h_mm": 0.0, "intensity": "none", "temperature_c": 28.26, "humidity_pct": 86, "pressure_hpa": 1011, "forecast_hourly": [{"timestamp": "2025-11-12T21:00:00", "rain_mm": 0.0, "temp_c": 28.05, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-12T22:00:00", "rain_mm": 0.0, "temp_c": 28.26, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-12T23:00:00", "rain_mm": 0.0, "temp_c": 27.93, "humidity_pct": 85, "pop": 0}, {"timestamp": "2025-11-13T00:00:00", "rain_mm": 0.0, "temp_c": 27.52, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T01:00:00", "rain_mm": 0.0, "temp_c": 27.6, "humidity_pct": 86, "pop": 0}, {"timestamp": "2025-11-13T02:00:00", "rain_mm": 0.0, "temp_c": 26.92, "humidity_pct": 87, "pop": 0}], "timestamp": "2025-11-12T21:56:57.253344", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.22, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.78, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.78, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -1.73, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.3, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.3, "rule_curve_elevation_m": 200.66, "deviation_from_rule_curve_m": 9.64, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.6, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 572.31, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -2.69, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -2.69, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.64, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.41, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.09, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.65, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.45, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.03, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.55, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.6, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.02, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 190.53, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -2.47, "rule_curve_elevation_m": 189.63, "deviation_from_rule_curve_m": 0.9, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": -0.39, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.38, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.62, "rule_curve_elevation_m": 219.62, "deviation_from_rule_curve_m": -3.24, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 0.07, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.58, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.58, "rule_curve_elevation_m": 278.94, "deviation_from_rule_curve_m": 1.64, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-12", "water_level_change_hr": 24.0, "water_level_change_amt": 2.33, "timestamp": "2025-11-12T21:56:58.298640", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-12T21:57:03.173664", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\minem\OneDrive\Documents\Coding Project\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

2025-11-13 13:55:21 - app.main - ERROR - broadcast:173 - Error sending to WebSocket: 
2025-11-13 13:55:21 - app.main - ERROR - broadcast:174 - Exception type: WebSocketDisconnect
2025-11-13 13:55:21 - app.main - ERROR - broadcast:176 - Traceback: Traceback (most recent call last):
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 331, in send
    output = self.conn.send(wsproto.events.Message(data=data))  # type: ignore
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\__init__.py", line 64, in send
    data += self.connection.send(event)
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\wsproto\connection.py", line 107, in send
    raise LocalProtocolError(
wsproto.utilities.LocalProtocolError: Event Message(data='{"type": "flood_update", "data": {"Montalban": {"water_level_m": null, "alert_level_m": 22.4, "alarm_level_m": 23.0, "critical_level_m": 23.6, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-13T13:55:10.148359", "source": "PAGASA_API"}, "Nangka": {"water_level_m": null, "alert_level_m": 16.5, "alarm_level_m": 17.1, "critical_level_m": 17.7, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-13T13:55:10.148359", "source": "PAGASA_API"}, "Rosario Bridge": {"water_level_m": null, "alert_level_m": 13.0, "alarm_level_m": 13.5, "critical_level_m": 14.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-13T13:55:10.148359", "source": "PAGASA_API"}, "Sto Nino": {"water_level_m": null, "alert_level_m": 15.0, "alarm_level_m": 16.0, "critical_level_m": 17.0, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-13T13:55:10.148359", "source": "PAGASA_API"}, "Tumana Bridge": {"water_level_m": null, "alert_level_m": 17.26, "alarm_level_m": 18.26, "critical_level_m": 19.26, "status": "normal", "risk_score": 0.0, "timestamp": "2025-11-13T13:55:10.148359", "source": "PAGASA_API"}, "Marikina_weather": {"location": "Marikina", "coordinates": [14.6507, 121.1029], "current_rainfall_mm": 0.0, "rainfall_24h_mm": 0.34, "forecast_6h_mm": 0.23, "intensity": "none", "temperature_c": 31.16, "humidity_pct": 74, "pressure_hpa": 1009, "forecast_hourly": [{"timestamp": "2025-11-13T13:00:00", "rain_mm": 0.0, "temp_c": 31.23, "humidity_pct": 73, "pop": 0.03}, {"timestamp": "2025-11-13T14:00:00", "rain_mm": 0.0, "temp_c": 31.16, "humidity_pct": 74, "pop": 0.39}, {"timestamp": "2025-11-13T15:00:00", "rain_mm": 0.0, "temp_c": 30.97, "humidity_pct": 73, "pop": 0.8}, {"timestamp": "2025-11-13T16:00:00", "rain_mm": 0.0, "temp_c": 30.93, "humidity_pct": 75, "pop": 0.78}, {"timestamp": "2025-11-13T17:00:00", "rain_mm": 0.23, "temp_c": 30.31, "humidity_pct": 77, "pop": 0.98}, {"timestamp": "2025-11-13T18:00:00", "rain_mm": 0.0, "temp_c": 29.54, "humidity_pct": 80, "pop": 0.73}], "timestamp": "2025-11-13T13:55:10.435624", "source": "OpenWeatherMap_API"}, "AMBUKLAO": {"dam_name": "AMBUKLAO", "reservoir_water_level_m": 750.52, "normal_high_water_level_m": 752.0, "deviation_from_nhwl_m": -1.48, "rule_curve_elevation_m": 752.0, "deviation_from_rule_curve_m": -1.48, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": 0.3, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "ANGAT": {"dam_name": "ANGAT", "reservoir_water_level_m": 210.02, "normal_high_water_level_m": 210.0, "deviation_from_nhwl_m": 0.02, "rule_curve_elevation_m": 200.94, "deviation_from_rule_curve_m": 9.08, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": -0.28, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "BINGA": {"dam_name": "BINGA", "reservoir_water_level_m": 573.7, "normal_high_water_level_m": 575.0, "deviation_from_nhwl_m": -1.3, "rule_curve_elevation_m": 575.0, "deviation_from_rule_curve_m": -1.3, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": 1.39, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "CALIRAYA": {"dam_name": "CALIRAYA", "reservoir_water_level_m": 287.19, "normal_high_water_level_m": 0.0, "deviation_from_nhwl_m": 0.0, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "watch", "risk_score": 0.3, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": -0.22, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "IPO": {"dam_name": "IPO", "reservoir_water_level_m": 100.97, "normal_high_water_level_m": 101.1, "deviation_from_nhwl_m": -0.13, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": 0.32, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "LA MESA": {"dam_name": "LA MESA", "reservoir_water_level_m": 78.63, "normal_high_water_level_m": 80.15, "deviation_from_nhwl_m": -1.52, "rule_curve_elevation_m": 0.0, "deviation_from_rule_curve_m": 0.0, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": 0.08, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "MAGAT DAM": {"dam_name": "MAGAT DAM", "reservoir_water_level_m": 189.86, "normal_high_water_level_m": 193.0, "deviation_from_nhwl_m": -3.14, "rule_curve_elevation_m": 189.75, "deviation_from_rule_curve_m": 0.11, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": -0.67, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "PANTABANGAN": {"dam_name": "PANTABANGAN", "reservoir_water_level_m": 216.33, "normal_high_water_level_m": 221.0, "deviation_from_nhwl_m": -4.67, "rule_curve_elevation_m": 219.7, "deviation_from_rule_curve_m": -3.37, "status": "normal", "risk_score": 0.1, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": -0.05, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}, "SAN ROQUE": {"dam_name": "SAN ROQUE", "reservoir_water_level_m": 280.72, "normal_high_water_level_m": 280.0, "deviation_from_nhwl_m": 0.72, "rule_curve_elevation_m": 278.84, "deviation_from_rule_curve_m": 1.88, "status": "alert", "risk_score": 0.5, "latest_time": "08:00 AM", "latest_date": "Nov-13", "water_level_change_hr": 24.0, "water_level_change_amt": 0.14, "timestamp": "2025-11-13T13:55:11.405119", "source": "PAGASA_Dam_Monitoring"}}, "timestamp": "2025-11-13T13:55:21.006381", "source": "flood_agent"}', frame_finished=True, message_finished=True) cannot be sent in state ConnectionState.CLOSED.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 86, in send
    await self._send(message)
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\_exception_handler.py", line 39, in sender
    await send(message)
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\uvicorn\protocols\websockets\wsproto_impl.py", line 350, in send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\app\main.py", line 170, in broadcast
    await connection.send_text(json_str)
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "C:\Users\Donald\Documents\Code\multi-agent-routing-app\masfro-backend\.venv\lib\site-packages\starlette\websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect

